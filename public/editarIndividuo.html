<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>SECRED | Ficha do Indiv√≠duo</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        .card { padding: 40px; }
        .tabs { display: flex; gap: 10px; border-bottom: 1px solid var(--border-color); margin-bottom: 30px; padding-bottom: 10px; }
        .tab-btn { background: transparent; border: none; color: var(--text-secondary); padding: 12px 24px; cursor: pointer; font-size: 0.95rem; font-weight: 600; border-radius: 6px; text-transform: uppercase; transition: 0.3s; }
        .tab-btn:hover { background-color: rgba(255,255,255,0.05); color: white; }
        .tab-btn.active { background-color: var(--accent-blue); color: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        .form-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 25px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .col-12 { grid-column: span 12; } .col-8 { grid-column: span 8; } .col-6 { grid-column: span 6; } .col-4 { grid-column: span 4; } .col-3 { grid-column: span 3; }
        label { font-size: 0.85rem; color: var(--accent-blue); font-weight: 700; text-transform: uppercase; margin-left: 2px; }
        input, select { padding: 12px 15px; background-color: #0f172a; border: 1px solid #334155; border-radius: 6px; color: white; font-size: 1rem; }
        input:disabled, select:disabled { background-color: #1e293b; color: #94a3b8; border-color: #334155; cursor: not-allowed; }
        .btn-add { background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; color: #10b981; padding: 10px 20px; cursor: pointer; border-radius: 6px; font-weight: bold; margin-bottom: 15px; display: inline-flex; align-items: center; gap: 5px; }
        .btn-remove { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid #ef4444; width: 100%; height: 45px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-pdf { background-color: #eab308; color: black; border: none; padding: 10px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; margin-right: 10px; }
        .tab-content { display: none; } .tab-content.active { display: block; animation: fadeIn 0.3s; }
        .lista-container { border-radius: 8px; padding: 20px; border: 1px dashed var(--border-color); min-height: 50px; }
        .item-row { display: grid; grid-template-columns: 1fr 1fr 1fr 50px; gap: 15px; align-items: end; background-color: var(--bg-panel); padding: 15px; border-radius: 6px; border: 1px solid var(--border-color); margin-bottom: 10px; }
        .crime-row { grid-template-columns: 1fr 50px; }
        .banco-row { grid-template-columns: 1fr 2fr 50px; }
    </style>
</head>
<body>

            <div class="sidebar">
        <div class="logo-container">
        <img src="img/logo.png" alt="Logo" class="logo-img">
        <div style="margin-top: 12px; font-size: 0.75rem; color: #64748b; text-transform: uppercase; letter-spacing: 1px;">
            Agente: <span id="agenteNome" style="color: white; font-weight: bold;">...</span>
        </div>
    </div>

        <nav class="nav-menu">
            <a href="admin.html" class="nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                </svg>
                <span>Administra√ß√£o</span>
            </a>
            <a href="index.html" class="nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect>
                </svg>
                <span>Dashboard</span>
            </a>

            <a href="tblEmpresa.html" class="nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 21h18M5 21V7l8-4 8 4v14M8 21v-2a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                <span>Empresas</span>
            </a>

            <a href="tblIndividuo.html" class="nav-item active">
                <svg class="nav-icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                <span>Indiv√≠duos</span>
            </a>
        </nav>

        <div class="nav-footer">
            <button onclick="logout()" class="btn-logout">
                <svg class="nav-icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                <span>Terminar Sess√£o</span>
            </button>
        </div>
    </div>

    <div class="main-content">
        <div class="header-section"><h1 class="page-title">Ficha Policial do Indiv√≠duo</h1></div>

        <div class="card">
            <div class="tabs">
                <button class="tab-btn active" onclick="openTab('geral')">1. Dados Pessoais</button>
                <button class="tab-btn" onclick="openTab('crimes')">2. Status & Crimes</button>
                <button class="tab-btn" onclick="openTab('veiculos')">3. Ve√≠culos</button>
                <button class="tab-btn" onclick="openTab('bancos')">4. Bancos</button>
            </div>

            <form id="formEditar">
                <div id="geral" class="tab-content active">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <div style="display:flex; justify-content:center; gap:20px; align-items:center; flex-direction: column;">
                            <img id="previewFoto" src="img/user.png" style="width:120px; height:120px; border-radius:50%; border:3px solid var(--accent-blue); object-fit:cover;">
                            <input type="file" id="fotoInput" accept="image/*" onchange="previewImage(this)" style="color:white;">
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group col-6"><label>Nome Completo *</label><input type="text" id="nome" class="create-form" maxlength="100" minlength="3" pattern="[a-zA-Z√†-√∫√Ä-√ö\s]+" required></div>
                        <div class="form-group col-3"><label>NIF / ID Civil *</label><input type="text" id="nif" class="create-form" maxlength="9" minlength="9" pattern="\d*" required></div>
                        <div class="form-group col-3"><label>Data Nascimento *</label><input type="date" id="dataNascimento" class="create-form" required></div>
                        <div class="form-group col-4"><label>Nacionalidade *</label><input type="text" id="nacionalidade" class="create-form" pattern="[a-zA-Z√†-√∫√Ä-√ö\s]+" maxlength="25" minlength="3" required></div>
                        <div class="form-group col-4"><label>Profiss√£o *</label><input type="text" id="profissao" class="create-form" minlength="3" maxlength="35" pattern="[a-zA-Z√†-√∫√Ä-√ö\s]+" required></div>
                        <div class="form-group col-4"><label>Estado Civil</label><input type="text" id="estadoCivil" class="create-form"  pattern="[a-zA-Z√†-√∫√Ä-√ö\s]+" minlength="5" maxlength="15"></div>
                        <div class="form-group col-8"><label>Morada Completa</label><input type="text" id="morada" class="create-form" pattern="[a-zA-Z√†-√∫√Ä-√ö0-9\s,.\-¬∫¬™/]+" minlength="10" maxlength="100"></div>
                        <div class="form-group col-4"><label>Telefone</label><input type="text" id="telefone" class="create-form" pattern="\d*"+" minlength="9" maxlength="40"></div>
                    </div>
                </div>

                <div id="crimes" class="tab-content">
                    <div class="form-grid">
                        <div class="form-group col-12">
                            <label>Status Operacional Atual</label>
                            <select id="statusOperacional" style="background-color: #1e293b; color: #fff; border: 1px solid var(--accent-blue);">
                                <option value="Livre">Livre</option>
                                <option value="Sob Vigil√¢ncia">Sob Vigil√¢ncia</option>
                                <option value="Procurado">Procurado</option>
                                <option value="Detido">Detido</option>
                                <option value="Desaparecido">Desaparecido</option>
                                <option value="√ìbito">√ìbito</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <label style="display:block; margin-bottom: 10px;">Registo Criminal</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <select id="crimeSelector" style="flex: 1;">
                                <option value="">-- Adicionar Novo Crime --</option>
                                <option>Homic√≠dio</option>
                                <option>Homic√≠dio Qualificado</option>
                                <option>Roubo</option>
                                <option>Furto Qualificado</option>
                                <option>Tr√°fico de Estupefacientes</option>
                                <option>Ofensa √† Integridade F√≠sica</option>
                                <option>Viol√™ncia Dom√©stica</option>
                                <option>Burla / Fraude</option>
                                <option>Condu√ß√£o Ilegal</option>
                                <option>Posse de Arma Proibida</option>
                            </select>
                            <button type="button" class="btn-add" id="btnAddCrime" onclick="addCrime()" style="margin-bottom:0;">+ Adicionar</button>
                        </div>
                        <div id="lista-crimes" class="lista-container"></div>
                    </div>
                </div>

                <div id="veiculos" class="tab-content">
                    <button type="button" class="btn-add" id="btnAddVeiculo" onclick="addVeiculo()">+ Associar Viatura</button>
                    <div id="lista-veiculos" class="lista-container"></div>
                </div>

                <div id="bancos" class="tab-content">
                    <button type="button" class="btn-add" id="btnAddBanco" onclick="addBanco()">+ Associar Conta</button>
                    <div id="lista-bancos" class="lista-container"></div>
                </div>

                <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between;">
                    <button type="button" onclick="gerarPDF()" class="btn-pdf">üìÑ Descarregar PDF</button>
                    <div>
                        <button type="button" onclick="history.back()" class="btn-action" style="background:#64748b; margin-right: 10px;">Voltar</button>
                        <button type="submit" id="btnGuardar" class="btn-action">Guardar Altera√ß√µes</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        const urlParams = new URLSearchParams(window.location.search);
        const idIndividuo = urlParams.get('id');
        const token = localStorage.getItem('token');
        const role = localStorage.getItem('role');
        let individuoData = {};

        $(document).ready(function() {
            if(!token) window.location.href = 'login.html';
            $('#agenteNome').text(localStorage.getItem('userNome'));

            carregarDados();

            if(role === 'patrulha') {
                $('input, select').prop('disabled', true);
                $('#btnGuardar, #btnAddVeiculo, #btnAddBanco, #btnAddCrime, #fotoInput, #btnMudarFoto').hide();
                $('.page-title').text('Ficha Policial (Modo Leitura)');
            }

            $('#formEditar').on('submit', function(e) {
                e.preventDefault();
                atualizarIndividuo();
            });
        });

        // --- FUN√á√ïES DE INTERFACE ---
        function openTab(tabId) { $('.tab-content').removeClass('active'); $('.tab-btn').removeClass('active'); $('#' + tabId).addClass('active'); event.target.classList.add('active'); }
        function logout() { localStorage.clear(); window.location.href = 'login.html'; }
        
        function previewImage(input) { 
            if (input.files && input.files[0]) { 
                const r = new FileReader(); 
                r.onload = e => $('#previewFoto').attr('src', e.target.result); 
                r.readAsDataURL(input.files[0]); 
            } 
        }

        // --- FUN√á√ïES DE LISTA ---
        function addVeiculo(mat='', marc='', mod='') {
            const btnDel = role === 'patrulha' ? '' : `<button type="button" class="btn-remove" onclick="$(this).closest('.item-row').remove()">X</button>`;
            const dis = role === 'patrulha' ? 'disabled' : '';
            $('#lista-veiculos').append(`<div class="item-row"><div><label class="lbl-create">Matr√≠cula</label><input type="text" pattern="[A-Z0-9]+" minlength="2" maxlength="15" class="v-mat create-form" value="${mat}" ${dis}></div><div><label class="lbl-create">Marca</label><input type="text" class="v-marca create-form" minlength="2" maxlength="25" pattern="[a-zA-Z√†-√∫√Ä-√ö\s\-\.&]+" value="${marc}" ${dis}></div><div><label class="lbl-create">Modelo</label><input type="text" class="v-modelo create-form" pattern="[a-zA-Z0-9√†-√∫√Ä-√ö\s\-\.]+" minlength="2" maxlength="25" value="${mod}" ${dis}></div><div>${btnDel}</div></div>`);
        }

        function addBanco(nome='', iban='') {
            const btnDel = role === 'patrulha' ? '' : `<button type="button" class="btn-remove" onclick="$(this).closest('.item-row').remove()">X</button>`;
            const dis = role === 'patrulha' ? 'disabled' : '';
            $('#lista-bancos').append(`<div class="item-row banco-row"><div><label class="lbl-create">Banco</label><input type="text" class="b-nome create-form" pattern="[a-zA-Z√†-√∫√Ä-√ö\s\-\.&]+" minlength="3" maxlength="40" value="${nome}" ${dis}></div><div><label class="lbl-create">IBAN</label><input type="text" class="b-iban create-form" minlength="25" maxlength="34" pattern="^[A-Z]{2}[0-9]{2}[A-Z0-9]+$" value="${iban}" ${dis}></div><div>${btnDel}</div></div>`);
        }

        function addCrime(nome='') {
            let crime = nome;
            if(!crime) crime = $('#crimeSelector').val();
            if(!crime) return;
            const btnDel = role === 'patrulha' ? '' : `<button type="button" class="btn-remove" onclick="$(this).closest('.item-row').remove()">X</button>`;
            $('#lista-crimes').append(`<div class="item-row crime-row"><input type="text" class="c-nome" value="${crime}" readonly style="background:#1e293b; border:none; color: white;"><div>${btnDel}</div></div>`);
            $('#crimeSelector').val(""); 
        }

        // --- API CALLS ---
        function carregarDados() {
            $.ajax({
                url: `${API_URL}/individuos/${idIndividuo}`,
                method: 'GET',
                headers: { 'auth-token': token },
                success: function(data) {
                    individuoData = data; // Guarda dados para o PDF
                    
                    $('#nome').val(data.nome);
                    $('#nif').val(data.nif);
                    $('#profissao').val(data.profissao);
                    $('#morada').val(data.morada);
                    $('#telefone').val(data.telefone);
                    $('#estadoCivil').val(data.estadoCivil);
                    $('#nacionalidade').val(data.nacionalidade);
                    
                    if(data.fotoUrl) $('#previewFoto').attr('src', data.fotoUrl);
                    if(data.dataNascimento) $('#dataNascimento').val(new Date(data.dataNascimento).toISOString().split('T')[0]);
                    if(data.statusOperacional) $('#statusOperacional').val(data.statusOperacional);

                    if(data.veiculos) data.veiculos.forEach(v => addVeiculo(v.matricula, v.marca, v.modelo));
                    if(data.contasBancarias) data.contasBancarias.forEach(b => addBanco(b.banco, b.iban));
                    if(data.crimes) data.crimes.forEach(c => addCrime(c));
                },
                error: function() { alert('Erro ao carregar dados.'); }
            });
        }

        function atualizarIndividuo() {
            const formData = new FormData();
            formData.append('nome', $('#nome').val());
            formData.append('nif', $('#nif').val());
            formData.append('profissao', $('#profissao').val());
            formData.append('morada', $('#morada').val());
            formData.append('telefone', $('#telefone').val());
            formData.append('estadoCivil', $('#estadoCivil').val());
            formData.append('nacionalidade', $('#nacionalidade').val());
            formData.append('dataNascimento', $('#dataNascimento').val());
            formData.append('statusOperacional', $('#statusOperacional').val());

            const fileInput = $('#fotoInput')[0];
            if(fileInput.files[0]) formData.append('foto', fileInput.files[0]);

            const veiculos = []; $('.item-row').has('.v-mat').each(function() { veiculos.push({ matricula: $(this).find('.v-mat').val(), marca: $(this).find('.v-marca').val(), modelo: $(this).find('.v-modelo').val() }); });
            formData.append('veiculos', JSON.stringify(veiculos));

            const contas = []; $('.item-row').has('.b-nome').each(function() { contas.push({ banco: $(this).find('.b-nome').val(), iban: $(this).find('.b-iban').val() }); });
            formData.append('contasBancarias', JSON.stringify(contas));

            const crimes = []; $('.c-nome').each(function() { crimes.push($(this).val()); });
            formData.append('crimes', JSON.stringify(crimes));

            $.ajax({
                url: `${API_URL}/individuos/${idIndividuo}`,
                method: 'PUT',
                headers: { 'auth-token': token },
                data: formData, processData: false, contentType: false,
                success: function() { 
                    alert('Ficha atualizada!'); 
                    location.reload(); // Recarrega para atualizar a vari√°vel individuoData
                },
                error: function(xhr) { alert('Erro: ' + xhr.responseText); }
            });
        }

        // --- FUN√á√ïES PDF ---
        
        function getBase64ImageFromURL(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.setAttribute("crossOrigin", "anonymous");
                img.onload = () => {
                    const canvas = document.createElement("canvas");
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(img, 0, 0);
                    resolve(canvas.toDataURL("image/jpeg"));
                };
                img.onerror = error => reject(error);
                img.src = url;
            });
        }

        // Fun√ß√£o que verifica se a p√°gina acabou e adiciona nova
        function checkPageBreak(doc, y) {
            if (y > 270) { // Se passar dos 270mm (A4 tem 297mm)
                doc.addPage();
                return 20; // Reinicia o Y no topo da nova p√°gina
            }
            return y;
        }

        async function gerarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 20;

            // FOTO
            if (individuoData.fotoUrl) {
                try {
                    const imgData = await getBase64ImageFromURL(individuoData.fotoUrl);
                    doc.addImage(imgData, 'JPEG', 150, 15, 40, 40); 
                    doc.setDrawColor(0);
                    doc.rect(150, 15, 40, 40); 
                } catch (err) { console.log("Erro imagem:", err); }
            } else {
                doc.setDrawColor(150);
                doc.rect(150, 15, 40, 40);
                doc.setFontSize(8);
                doc.text("Sem Foto", 160, 35);
            }

            // CABE√áALHO
            doc.setFontSize(22); doc.setTextColor(40, 40, 40); doc.text("SECRED", 20, 25);
            doc.setFontSize(14); doc.setTextColor(100); doc.text("FICHA DO INDIV√çDUO", 20, 32);
            doc.setFontSize(10); doc.text("ID: " + idIndividuo, 20, 40);
            
            y = 65; 
            doc.setLineWidth(0.5); doc.setDrawColor(200); doc.line(20, y, 190, y); y += 10;

            // 1. DADOS
            doc.setFontSize(14); doc.setTextColor(0); doc.text("1. IDENTIFICA√á√ÉO", 20, y); y += 10;
            doc.setFontSize(11); doc.setTextColor(50);
            
            doc.text(`Nome: ${individuoData.nome || '-'}`, 20, y); y += 7;
            doc.text(`NIF: ${individuoData.nif || '-'}`, 20, y); y += 7;
            doc.text(`Nasc.: ${individuoData.dataNascimento ? new Date(individuoData.dataNascimento).toLocaleDateString() : '-'}`, 20, y); y += 7;
            doc.text(`Morada: ${individuoData.morada || '-'}`, 20, y); y += 7;
            doc.text(`Telefone: ${individuoData.telefone || '-'}`, 20, y); y += 15;

            // 2. STATUS & CRIMES
            y = checkPageBreak(doc, y);
            doc.setFontSize(14); doc.setTextColor(0); doc.text("2. STATUS & CRIMES", 20, y); y += 10;
            
            doc.setFontSize(11); 
            doc.setTextColor(220, 38, 38); 
            doc.setFont(undefined, 'bold');
            doc.text(`STATUS: ${individuoData.statusOperacional || 'Livre'}`, 20, y); y += 10;
            doc.setFont(undefined, 'normal');
            
            doc.setTextColor(50); doc.text("Crimes:", 20, y); y += 7;
            if(individuoData.crimes && individuoData.crimes.length > 0) {
                individuoData.crimes.forEach(c => { 
                    y = checkPageBreak(doc, y);
                    doc.text(`- ${c}`, 30, y); y += 6; 
                });
            } else { doc.text("- Sem registo.", 30, y); y += 6; }
            y += 5;

            // 3. PATRIM√ìNIO
            y = checkPageBreak(doc, y);
            doc.setFontSize(14); doc.setTextColor(0); doc.text("3. PATRIM√ìNIO", 20, y); y += 10;
            
            doc.setFontSize(11); doc.setTextColor(50);
            doc.text("Ve√≠culos:", 20, y); y += 7;
            if(individuoData.veiculos && individuoData.veiculos.length > 0) {
                individuoData.veiculos.forEach(v => { 
                    y = checkPageBreak(doc, y);
                    doc.text(`- ${v.marca} ${v.modelo} (${v.matricula})`, 30, y); y += 6; 
                });
            } else { doc.text("- N/A", 30, y); y += 6; }
            
            y += 5;
            y = checkPageBreak(doc, y);
            doc.text("Contas Banc√°rias:", 20, y); y += 7;
            if(individuoData.contasBancarias && individuoData.contasBancarias.length > 0) {
                individuoData.contasBancarias.forEach(b => { 
                    y = checkPageBreak(doc, y);
                    doc.text(`- ${b.banco} | IBAN: ${b.iban}`, 30, y); y += 6; 
                });
            } else { doc.text("- N/A", 30, y); }

            doc.save(`Suspeito_${individuoData.nif}.pdf`);
        }
    </script>
</body>
</html>