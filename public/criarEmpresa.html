<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>SECRED | Nova Organização</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        .card { padding: 40px; }
        .tabs { display: flex; gap: 10px; border-bottom: 1px solid var(--border-color); margin-bottom: 30px; padding-bottom: 10px; }
        .tab-btn { background: transparent; border: none; color: var(--text-secondary); padding: 12px 24px; cursor: pointer; font-size: 0.95rem; font-weight: 600; border-radius: 6px; text-transform: uppercase; transition: 0.3s; }
        .tab-btn:hover { background-color: rgba(255,255,255,0.05); color: var(--accent-blue); }
        .tab-btn.active { background-color: var(--accent-blue); color: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        .form-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 25px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .col-12 { grid-column: span 12; } .col-6 { grid-column: span 6; } .col-4 { grid-column: span 4; } .col-3 { grid-column: span 3; }
        label { font-size: 0.85rem; color: var(--accent-blue); font-weight: 700; text-transform: uppercase; margin-left: 2px; }
        input, select { padding: 12px 15px; background-color: #0f172a; border: 1px solid #334155; border-radius: 6px; color: white; font-size: 1rem; }
        .lista-container { border-radius: 8px; padding: 20px; border: 1px dashed var(--border-color); min-height: 50px; }
        .item-row { display: grid; grid-template-columns: 1fr 1fr 1fr 50px; gap: 15px; align-items: end; background-color: var(--bg-panel); padding: 15px; border-radius: 6px; border: 1px solid var(--border-color); margin-bottom: 10px; }
        .crime-row { grid-template-columns: 1fr 50px; }
        .banco-row { grid-template-columns: 1fr 2fr 50px; }
        .btn-add { background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; color: #10b981; padding: 10px 20px; cursor: pointer; border-radius: 6px; font-weight: bold; margin-bottom: 15px; display: inline-flex; align-items: center; gap: 5px; }
        .btn-remove { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid #ef4444; width: 100%; height: 45px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .tab-content { display: none; } .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo-container">
            <img src="img/logo.png" alt="Logo" class="logo-img">
            <div style="margin-top: 12px; font-size: 0.75rem; color: #64748b; text-transform: uppercase; letter-spacing: 1px;">
                Agente: <span id="agenteNome" style="color: white; font-weight: bold;">...</span>
            </div>
        </div>

        <nav class="nav-menu">
            <a href="admin.html" class="nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                </svg>
                <span>Administração</span>
            </a>
            <a href="index.html" class="nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect>
                </svg>
                <span>Dashboard</span>
            </a>

            <a href="tblEmpresa.html" class="nav-item active">
                <svg class="nav-icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 21h18M5 21V7l8-4 8 4v14M8 21v-2a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                <span>Empresas</span>
            </a>

            <a href="tblIndividuo.html" class="nav-item">
                <svg class="nav-icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                <span>Indivíduos</span>
            </a>
        </nav>

        <div class="nav-footer">
            <button onclick="logout()" class="btn-logout">
                <svg class="nav-icon" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                <span>Terminar Sessão</span>
            </button>
        </div>
    </div>

    <div class="main-content">
        <div class="header-section"><h1 class="page-title">Criar Nova Empresa</h1></div>

        <div class="card">
            <div class="tabs">
                <button class="tab-btn active" onclick="openTab('geral')">1. Dados Gerais</button>
                <button class="tab-btn" onclick="openTab('socios')">2. Sócios / Gerência</button>
                <button class="tab-btn" onclick="openTab('crimes')">3. Crimes</button>
                <button class="tab-btn" onclick="openTab('veiculos')">4. Frota Veículos</button>
                <button class="tab-btn" onclick="openTab('bancos')">5. Dados Bancários</button>
            </div>

            <form id="formCriar">
                <div id="geral" class="tab-content active">
                    <div class="form-grid">
                        <div class="form-group col-6"><label>Nome da Entidade *</label><input type="text" class="create-form" id="nome" pattern="[a-zA-Z0-9à-úÀ-Ú\s\-\.\,]+" minlength="2" maxlength="60" required></div>
                        <div class="form-group col-3"><label>NIF *</label><input type="text" class="create-form" id="nif" maxlength="9" minlength="9" pattern="\d*" placeholder="512346789" required></div>
                        <div class="form-group col-3"><label>Capital Social (€)</label><input type="number" class="create-form" id="capitalSocial" min="1" step="1" placeholder="5000"></div>
                        <div class="form-group col-6"><label>Morada Sede</label><input type="text" class="create-form" id="morada" pattern="[a-zA-Zà-úÀ-Ú0-9\s,.\-ºª/]+" minlength="10" maxlength="100"></div>
                        <div class="form-group col-3"><label>Localidade</label><input type="text" class="create-form" id="localidade" pattern="[a-zA-Zà-úÀ-Ú\s]+" minlength="5" maxlength="40"></div>
                        <div class="form-group col-3"><label>Código Postal</label><input type="text" class="create-form" id="codPostal" pattern="[0-9]{4}-[0-9]{3}" placeholder="4100-100" maxlength="8"></div>
                        <div class="form-group col-6"><label>Email de Contacto</label><input type="email" class="create-form" id="email"></div>
                        <div class="form-group col-6"><label>Telefone</label><input type="text" class="create-form" id="telefone" pattern="\d*" maxlength="9" minlength="9" placeholder="912345678"></div>
                        <div class="form-group col-12" style="border: 1px dashed #334155; padding: 20px; border-radius: 8px;">
                            <label>Logótipo / Foto</label>
                            <div style="display: flex; gap: 20px; align-items: center;">
                                <input type="file" id="fotoInput" accept="image/*" onchange="previewImage(this)">
                                <img id="imgPreview" src="img/user.png" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid var(--accent-blue);">
                            </div>
                        </div>
                    </div>
                </div>

                <div id="socios" class="tab-content">
                    <div class="form-grid">
                        <div class="form-group col-8">
                        <label>Procurar indivíduo (Nome ou NIF)</label>
                        <input type="text" id="socioQuery" placeholder="Escreve pelo menos 2 letras ou números">
                        <div id="socioResultados" class="lista-container" style="margin-top:10px;"></div>

                        <div id="socioMsg" style="margin-top:10px; color:#94a3b8;"></div>

                        <button type="button" id="btnCriarIndividuo" class="btn-add" style="display:none;" onclick="irCriarIndividuo()">
                            + Criar novo indivíduo
                        </button>
                        </div>
                    </div>

                    <div style="margin-top:15px;">
                        <label>Sócios/Gerentes associados</label>
                        <div id="lista-socios" class="lista-container"></div>
                    </div>
                    </div>


                <div id="socios" class="tab-content">
                    <div class="form-grid">
                        <div class="form-group col-8">
                        <label>Procurar indivíduo (Nome ou NIF)</label>
                        <input type="text" id="socioQuery" placeholder="Escreve pelo menos 2 letras/números">
                        <div id="socioResultados" class="lista-container" style="margin-top:10px;"></div>
                        <div id="socioMsg" style="margin-top:10px;"></div>
                        <button type="button" id="btnCriarIndividuo" class="btn-add" style="display:none;" onclick="irCriarIndividuo()">+ Criar novo indivíduo</button>
                        </div>
                    </div>

                    <div style="margin-top:15px;">
                        <label>Sócios/Gerentes associados</label>
                        <div id="lista-socios" class="lista-container"></div>
                    </div>
                </div>




                <div id="crimes" class="tab-content">
                    <div class="form-grid">
                        <div class="form-group col-12">
                            <label>Status da Empresa</label>
                            <select id="statusOperacional" style="background-color: #1e293b; color: #fff; border: 1px solid var(--accent-blue);">
                                <option value="Ativa">Ativa</option>
                                <option value="Sob Investigação">Sob Investigação</option>
                                <option value="Processo de Insolvência">Processo de Insolvência</option>
                                <option value="Suspensa">Suspensa</option>
                                <option value="Encerrada Compulsivamente">Encerrada Compulsivamente</option>
                            </select>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <label style="display:block; margin-bottom: 10px;">Crimes / Infrações</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <select id="crimeSelector" style="flex: 1;">
                                <option value="">-- Selecionar Infração --</option>
                                <option>Fraude Fiscal</option>
                                <option>Branqueamento de Capitais</option>
                                <option>Falsificação de Documentos</option>
                                <option>Tráfico de Influências</option>
                                <option>Crime Ambiental</option>
                                <option>Exploração Laboral</option>
                                <option>Tráfico Humano</option>
                                <option>Corrupção Ativa</option>
                            </select>
                            <button type="button" class="btn-add" onclick="addCrime()" style="margin-bottom:0;">+ Adicionar</button>
                        </div>
                        <div id="lista-crimes" class="lista-container"></div>
                    </div>
                </div>

                <div id="veiculos" class="tab-content">
                    <button type="button" class="btn-add" onclick="addVeiculo()">+ Adicionar Veículo</button>
                    <div id="lista-veiculos" class="lista-container"></div>
                </div>

                <div id="bancos" class="tab-content">
                    <button type="button" class="btn-add" onclick="addBanco()">+ Adicionar Conta</button>
                    <div id="lista-bancos" class="lista-container"></div>
                </div>

                <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 10px;">
                    <button type="button" onclick="history.back()" class="btn-action" style="background:#64748b;">Voltar</button>
                    <button type="submit" class="btn-action" style="padding: 15px 40px;">Criar Ficha</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        if(!localStorage.getItem('token')) window.location.href = 'login.html';
        $('#agenteNome').text(localStorage.getItem('userNome'));
        function logout() { localStorage.clear(); window.location.href = 'login.html'; }
        function openTab(tabId) { $('.tab-content').removeClass('active'); $('.tab-btn').removeClass('active'); $('#' + tabId).addClass('active'); event.target.classList.add('active'); }
        function previewImage(input) { if (input.files && input.files[0]) { const r = new FileReader(); r.onload = e => $('#imgPreview').attr('src', e.target.result); r.readAsDataURL(input.files[0]); } }
        function addVeiculo() { $('#lista-veiculos').append(`<div class="item-row"><div><label class="lbl-create">Matrícula</label><input type="text" placeholder="Ex: 1234AB" class="v-mat create-form" pattern="[A-Z0-9]+" minlength="2" maxlength="15"></div><div><label class="lbl-create">Marca</label><input type="text" placeholder="Ex: Ford" class="v-marca create-form" minlength="2" maxlength="25" pattern="[a-zA-Zà-úÀ-Ú\s\-\.&]+"></div><div><label class="lbl-create">Modelo</label><input type="text" placeholder="Ex: Focus" class="v-modelo create-form" pattern="[a-zA-Z0-9à-úÀ-Ú\s\-\.]+" minlength="2" maxlength="25"></div><div><button type="button" class="btn-remove" onclick="$(this).closest('.item-row').remove()">X</button></div></div>`); }
        function addBanco() { $('#lista-bancos').append(`<div class="item-row banco-row"><div><label class="lbl-create">Banco</label><input type="text" placeholder="Ex: Montepio" class="b-nome create-form" pattern="^[^0-9]+$" minlength="3" maxlength="40"></div><div><label class="lbl-create">IBAN</label><input type="text" placeholder="Ex: PT50123456789012345678901" class="b-iban create-form emp-iban-create" minlength="25" maxlength="34" pattern="^[A-Z]{2}[0-9]{2}[A-Z0-9]+$"></div><div><button type="button" class="btn-remove" onclick="$(this).closest('.item-row').remove()">X</button></div></div>`); }
        
        function addCrime() {
            const crime = $('#crimeSelector').val();
            if(!crime) return;
            $('#lista-crimes').append(`<div class="item-row crime-row"><input type="text" class="c-nome" value="${crime}" readonly style="background:#1e293b; border:none; color: white;"><div><button type="button" class="btn-remove" onclick="$(this).closest('.item-row').remove()">X</button></div></div>`);
            $('#crimeSelector').val(""); 
        }

        // ---------- SÓCIOS / GERÊNCIA (LIVE SEARCH) ----------
        let tPesquisaSocio = null;
        let ultimoQSocio = '';

        $('#socioQuery').on('input', function () {
        const q = $(this).val().trim();
        $('#socioMsg').text('');
        $('#btnCriarIndividuo').hide();
        clearTimeout(tPesquisaSocio);
        tPesquisaSocio = setTimeout(() => pesquisarIndividuos(q), 250);
        });

        function pesquisarIndividuos(q) {
        const token = localStorage.getItem('token');

        if (q.length < 2) {
            $('#socioResultados').html('');
            return;
        }
        if (q === ultimoQSocio) return;
        ultimoQSocio = q;

        $.ajax({
            url: `/api/individuos/pesquisa?q=${encodeURIComponent(q)}`,
            method: 'GET',
            headers: { 'auth-token': token },
            success: function (lista) {
            renderResultadosIndividuos(lista, q);
            },
            error: function (xhr) {
            $('#socioMsg').css('color', '#ef4444').text('Erro na pesquisa: ' + xhr.responseText);
            }
        });
        }

        function renderResultadosIndividuos(lista, q) {
        if (!lista || lista.length === 0) {
            $('#socioResultados').html('<div style="color:#94a3b8;">Sem resultados.</div>');
            $('#btnCriarIndividuo').show().data('q', q);
            return;
        }

        const html = lista.map(ind => `
            <div class="item-row" style="grid-template-columns: 1fr 120px; cursor:pointer;">
            <div>
                <strong>${ind.nome}</strong><br>
                <small>NIF: ${ind.nif}</small>
            </div>
            <div style="text-align:right;">
                <button type="button" class="btn-add" style="margin:0;" onclick='selecionarIndividuo(${JSON.stringify(ind)})'>Selecionar</button>
            </div>
            </div>
        `).join('');

        $('#socioResultados').html(html);
        }

        function selecionarIndividuo(ind) {
        addSocioRow(ind);
        $('#socioQuery').val('');
        $('#socioResultados').html('');
        $('#btnCriarIndividuo').hide();
        $('#socioMsg').css('color', '#94a3b8').text('');
        }

        function addSocioRow(ind, funcao = 'SOCIO', percentagem = '') {
        // Evitar duplicados (mesmo NIF)
        const jaExiste = $('#lista-socios .socio-nif').toArray().some(el => $(el).text() === ind.nif);
        if (jaExiste) return;

        const html = `
            <div class="item-row socio-row" style="grid-template-columns: 1fr 140px 140px 50px;">
            <div>
                <strong class="socio-nome">${ind.nome}</strong><br>
                <small class="socio-nif">${ind.nif}</small>
                <input type="hidden" class="socio-id" value="${ind._id}">
            </div>

            <div>
                <label>Função</label>
                <select class="socio-funcao">
                <option value="SOCIO" ${funcao === 'SOCIO' ? 'selected' : ''}>Sócio</option>
                <option value="GERENTE" ${funcao === 'GERENTE' ? 'selected' : ''}>Gerente</option>
                </select>
            </div>

            <div>
                <button type="button" class="btn-remove" onclick="this.closest('.socio-row').remove()">X</button>
            </div>
            </div>
        `;

        $('#lista-socios').append(html);
        }

        function irCriarIndividuo() {
        const q = ($('#btnCriarIndividuo').data('q') || '').trim();
        const soNumeros = /^[0-9]+$/.test(q);

        const url = soNumeros
            ? `criarIndividuo.html?nif=${encodeURIComponent(q)}`
            : `criarIndividuo.html?nome=${encodeURIComponent(q)}`;

        window.location.href = url;
        }



        $('#formCriar').on('submit', function(e) {
            e.preventDefault();
            const token = localStorage.getItem('token');
            const formData = new FormData();

            formData.append('nome', $('#nome').val());
            formData.append('nif', $('#nif').val());
            formData.append('capitalSocial', $('#capitalSocial').val());
            formData.append('morada', $('#morada').val());
            formData.append('localidade', $('#localidade').val());
            formData.append('codPostal', $('#codPostal').val());
            formData.append('email', $('#email').val());
            formData.append('telefone', $('#telefone').val());
            formData.append('statusOperacional', $('#statusOperacional').val());

            const fileInput = $('#fotoInput')[0];
            if (fileInput.files[0]) formData.append('foto', fileInput.files[0]);

            const veiculos = []; $('.item-row').has('.v-mat').each(function() { veiculos.push({ matricula: $(this).find('.v-mat').val(), marca: $(this).find('.v-marca').val(), modelo: $(this).find('.v-modelo').val() }); });
            formData.append('veiculos', JSON.stringify(veiculos));

            const contas = []; $('.item-row').has('.b-nome').each(function() { contas.push({ banco: $(this).find('.b-nome').val(), iban: $(this).find('.b-iban').val() }); });
            formData.append('contasBancarias', JSON.stringify(contas));

            const crimes = []; $('.c-nome').each(function() { crimes.push($(this).val()); });
            formData.append('crimes', JSON.stringify(crimes));

            const sociosGerentes = [];
            $('#lista-socios .socio-row').each(function () {
            sociosGerentes.push({
                individuo: $(this).find('.socio-id').val(),
                funcao: $(this).find('.socio-funcao').val(),
                percentagem: Number($(this).find('.socio-percentagem').val() || 0)
            });
            });

            formData.append('sociosGerentes', JSON.stringify(sociosGerentes));


            $.ajax({
                url: '/api/empresas',
                method: 'POST',
                headers: { 'auth-token': token },
                data: formData, processData: false, contentType: false,
                success: function() { alert('Sucesso!'); window.location.href = 'tblEmpresa.html'; },
                error: function(xhr) { alert('Erro: ' + xhr.responseText); }
            });

            const APIURL = '/api';
                let tPesquisa = null;
                let ultimoQ = '';

                $('#socioQuery').on('input', function() {
                const q = $(this).val().trim();
                $('#socioMsg').text('');
                $('#btnCriarIndividuo').hide();

                clearTimeout(tPesquisa);
                tPesquisa = setTimeout(() => pesquisarLive(q), 250);
            });
        });
    </script>
</body>
</html>